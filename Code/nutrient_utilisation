install.packages(c("tidyr", "tidyverse", "rnaturalearth", "rnaturalearthdata", "sf", "ggplot2", "grid", "dplyr", "patchwork", "here", 
"meta", "metafor", "clubSandwich", "robumeta", "devtools", "MASS"))

# Load necessary libraries
library(dplyr)
library(tidyr)
library(tidyverse)
library(rnaturalearth)  
library(rnaturalearthdata)
library(sf)              
library(ggplot2)
library(grid)
library(patchwork)
library(here)
library(metafor)
library(meta)
library(clubSandwich)
library(robumeta)
library(MASS)

#install.packages("pacman")
rm(list = ls())
devtools::install_github("daniel1noble/orchaRd", ref = "main", force = TRUE)
pacman::p_load(devtools, tidyverse, metafor, patchwork, R.rsp, orchaRd, emmeans, ape, phytools, flextable)

###Please download GitHub repository and then run the following
here()
mydata <- read_csv(here("GitHub", "UlvaSupplements_AbaloneMA", "Data", "Ulva inclusion in Haliotis sp. diets_A Meta-analysis - Data"))
head(mydata)

#Add another column to assign short citation
citations <- data.frame(
  study_ID = c("S001", "S002", "S003", "S004", "S005", "S006", "S007", "S008","S009", "S010", "S011"),
  short_citation = c(
    "Bansemer et al. (2016)",
    "Lange et al. (2014)",
    "Stone et al. (2022)",
    "Francis et al. (2021)",
    "Mwangudza (2024)",
    "Falade (2023)",
    "Bates et al. (2017)",
    "Chi et al. (2018)",
    "Angell et al. (2012)",
    "Searle et al. (2025)", 
    "Duong et al. (2021)" 
  ))

mydata <- mydata %>%
  left_join(citations, by = "study_ID")

#Add long outcome names
mydata <- mydata %>%
  mutate(
    outcome_long = case_when(
      outcome == "FI"  ~ "Feed intake",
      outcome == "BG"  ~ "Biomass gain",
      outcome == "CF"  ~ "Condition factor",
      outcome == "FW"  ~ "Final weight",
      outcome == "FSL" ~ "Final shell length",
      outcome == "SG"  ~ "Shell gain",
      outcome == "SGR" ~ "Specific growth rate",
      outcome == "WG"  ~ "Weight gain",
      outcome == "EER" ~ "Energy efficiency ratio",
      outcome == "ED"  ~ "Energy deposition",
      outcome == "FCR" ~ "Feed conversion ratio",
      outcome == "PER" ~ "Protein efficiency ratio",
      outcome == "PD"  ~ "Protein deposition",
      outcome == "LG"  ~ "Length gain",
      outcome == "I" ~ "Ingested feed energy", 
      outcome == "Pg" ~ "Somatic feed energy", 
      outcome == "S" ~ "Shell growth energy",
      TRUE ~ outcome
    )
  )

######### Nutrient Utilisation
# Filter for nutrient utilisation
nutrient_data <- mydata %>%
  filter(outcome_category == "nutrient utilisation")
nutrient_data$intervention_preparation <- as.factor(nutrient_data$intervention_preparation)
print(nutrient_data)

# Summarise number of studies and effect sizes
nutrient_dataset <- nutrient_data %>%
  summarise(
    n_studies = n_distinct(study_ID),
    n_effects = n_distinct(experiment_ID),
    .groups = "drop"
  )
nutrient_dataset

# Calculate effect size (Hedges g) and pooled SD
nutrient_data <- nutrient_data %>%
  mutate(
    s_pooled_nutrient = sqrt(((treatment_n - 1) * treatment_SD^2 + (control_n - 1) * control_SD^2) /
                    (treatment_n + control_n - 2)),
    J_nutrient = 1 - (3 / (4 * (treatment_n + control_n) - 9)),
    g_nutrient = J_nutrient * ((treatment_mean - control_mean) / s_pooled_nutrient),
    vi_g_nutrient = (treatment_n + control_n) / (treatment_n * control_n) + (g_nutrient^2 / (2 * (treatment_n + control_n - 2)))
  )

# Reverse sign for outcomes where lower values are better (e.g., FCR)
nutrient_data <- nutrient_data %>%
  mutate(
    g_nutrient = ifelse(outcome == "FCR", -g_nutrient, g_nutrient),
    vi_g_nutrient = ifelse(outcome == "FCR", vi_g_nutrient, vi_g_nutrient))

# Run MLMA with species as additional random effect
res_3L_nutrient_species <- rma.mv(yi = g_nutrient, V = vi_g_nutrient,
  random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID
  ),
  data = nutrient_data,
  method = "REML"
)
res_3L_nutrient_species

# Extract variance components
sigma_species_nutrient <- res_3L_nutrient_species$sigma2[1]
sigma_study_nutrient <- res_3L_nutrient_species$sigma2[2]
sigma_exp_nutrient <- res_3L_nutrient_species$sigma2[3]

# Mean sampling variance
mean_vi_nutrient <- mean(nutrient_data$vi_g_nutrient)

# Total variance
total_var_nutrient <- sigma_species_nutrient + sigma_study_nutrient + sigma_exp_nutrient + mean_vi_nutrient 

# I² calculations
I2_species_nutrient <- sigma_species_nutrient / total_var_nutrient * 100
I2_study_nutrient <- sigma_study_nutrient / total_var_nutrient * 100
I2_exp_nutrient <- sigma_exp_nutrient / total_var_nutrient * 100
I2_total_nutrient <- (sigma_species_nutrient + sigma_study_nutrient + sigma_exp_nutrient) / total_var_nutrient * 100

I2_species_nutrient; I2_study_nutrient; I2_exp_nutrient; I2_total_nutrient

# Orchard plot (overall effect)
orchaRd::orchard_plot(res_3L_nutrient_species,
                        mod = "1",      # no moderator → "overall" model
                        at = NULL,
                        group = "study_ID",
                        xlab = "g_nutrient",
                        transfm = "none",  # no transformation
                        twig.size = 0.5,    # 95% CI
                        trunk.size = 0.1)

I2_nutrient <- orchaRd::i2_ml(res_3L_nutrient_species)

nutrient_plot <- orchaRd::orchard_plot(
   res_3L_nutrient_species,
    mod = "1",
    xlab = "Effect Size (Hedges g)",
    group = "study_ID"
) +
  annotate(
    geom = "text",
    x = 0.7,
    y = 10,
    label = paste0("italic(I)^{2} == ", round(I2_nutrient[1], 4), "*\"%\""),
    color = "black",
    parse = TRUE,
    size = 5
  ) +
  scale_fill_manual(values = "grey") +
  scale_colour_manual(values = "grey")

# Testing impact of moderators in univariate models
# Experimental duration
res_duration <- rma.mv(yi = g_nutrient, V = vi_g_nutrient, mods = ~ study_duration_days, random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID 
  ), data = nutrient_data)
summary(res_duration)

# Extract variance components
sigma_species_nutrient_duration <- res_duration$sigma2[1]
sigma_study_nutrient_duration <- res_duration$sigma2[2]
sigma_exp_nutrient_duration <- res_duration$sigma2[3]

# Total variance
total_var_nutrient_duration <- sigma_species_nutrient_duration + sigma_study_nutrient_duration + sigma_exp_nutrient_duration + mean_vi_nutrient 

# I² calculations
I2_species_nutrient_duration <- sigma_species_nutrient_duration / total_var_nutrient_duration * 100
I2_study_nutrient_duration <- sigma_study_nutrient_duration / total_var_nutrient_duration * 100
I2_exp_nutrient_duration <- sigma_exp_nutrient_duration / total_var_nutrient_duration * 100
I2_total_nutrient_duration <- (sigma_species_nutrient_duration + sigma_study_nutrient_duration + sigma_exp_nutrient_duration) / total_var_nutrient_duration * 100

I2_species_nutrient_duration; I2_study_nutrient_duration; I2_exp_nutrient_duration; I2_total_nutrient_duration

# Variance explained by duration
tau2_res_duration <- sum(res_duration$sigma2)
tau2_res_3L_nutrient_species <- sum(res_3L_nutrient_species$sigma2)
R2_duration <- (tau2_res_3L_nutrient_species - tau2_res_duration) / tau2_res_3L_nutrient_species * 100
print(R2_duration)

# Initial size as a moderator
res_size <- rma.mv(yi = g_nutrient, V = vi_g_nutrient, mods = ~ initial_size_g, random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID 
  ), data = nutrient_data)
summary(res_size)

# Extract variance components
sigma_species_nutrient_size <- res_size$sigma2[1]
sigma_study_nutrient_size <- res_size$sigma2[2]
sigma_exp_nutrient_size <- res_size$sigma2[3]

# Total variance
total_var_nutrient_size <- sigma_species_nutrient_size + sigma_study_nutrient_size + sigma_exp_nutrient_size + mean_vi_nutrient 

# I² calculations
I2_species_nutrient_size <- sigma_species_nutrient_size / total_var_nutrient_size * 100
I2_study_nutrient_size <- sigma_study_nutrient_size / total_var_nutrient_size * 100
I2_exp_nutrient_size <- sigma_exp_nutrient_size / total_var_nutrient_size * 100
I2_total_nutrient_size <- (sigma_species_nutrient_size + sigma_study_nutrient_size + sigma_exp_nutrient_size) / total_var_nutrient_size * 100

I2_species_nutrient_size; I2_study_nutrient_size; I2_exp_nutrient_size; I2_total_nutrient_size

# Variance explained by size
tau2_res_size <- sum(res_size$sigma2)
R2_size <- (tau2_res_3L_nutrient_species - tau2_res_size) / tau2_res_3L_nutrient_species * 100
print(R2_size)

# Ulva dose (linear) as moderator
res_dose_linear <- rma.mv(yi = g_nutrient, V = vi_g_nutrient, mods = ~ intervention_dose, random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID 
  ), data = nutrient_data)
summary(res_dose_linear)

# Extract variance components
sigma_species_dose_linear <- res_dose_linear$sigma2[1]
sigma_study_dose_linear <- res_dose_linear$sigma2[2]
sigma_exp_dose_linear <- res_dose_linear$sigma2[3]

# Total variance
total_var_dose_linear <- sigma_species_dose_linear + sigma_study_dose_linear + sigma_exp_dose_linear + mean_vi_nutrient 

# I² calculations
I2_species_dose_linear <- sigma_species_dose_linear / total_var_dose_linear * 100
I2_study_dose_linear <- sigma_study_dose_linear / total_var_dose_linear * 100
I2_exp_dose_linear <- sigma_exp_dose_linear / total_var_dose_linear * 100
I2_total_dose_linear <- (sigma_species_dose_linear + sigma_study_dose_linear + sigma_exp_dose_linear) / total_var_dose_linear * 100

I2_species_dose_linear; I2_study_dose_linear; I2_exp_dose_linear; I2_total_dose_linear

# Variance explained by linear dose
tau2_res_dose_linear <- sum(res_dose_linear$sigma2)
R2_dose_linear <- (tau2_res_3L_nutrient_species - tau2_res_dose_linear) / tau2_res_3L_nutrient_species * 100
print(R2_dose_linear)

# Ulva dose (quadratic)
res_dose_quadratic <- rma.mv(yi = g_nutrient, V = vi_g_nutrient, mods = ~ intervention_dose + I(intervention_dose^2), random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID 
  ), data = nutrient_data)
summary(res_dose_quadratic)

# Extract variance components
sigma_species_dose_quadratic <- res_dose_quadratic$sigma2[1]
sigma_study_dose_quadratic   <- res_dose_quadratic$sigma2[2]
sigma_exp_dose_quadratic     <- res_dose_quadratic$sigma2[3]

# Total variance
total_var_dose_quadratic <- sigma_species_dose_quadratic + sigma_study_dose_quadratic + sigma_exp_dose_quadratic + mean_vi_nutrient 

# I² calculations
I2_species_dose_quadratic <- sigma_species_dose_quadratic / total_var_dose_quadratic * 100
I2_study_dose_quadratic   <- sigma_study_dose_quadratic   / total_var_dose_quadratic * 100
I2_exp_dose_quadratic     <- sigma_exp_dose_quadratic     / total_var_dose_quadratic * 100
I2_total_dose_quadratic   <- (sigma_species_dose_quadratic + sigma_study_dose_quadratic + sigma_exp_dose_quadratic) / total_var_dose_quadratic * 100

I2_species_dose_quadratic; I2_study_dose_quadratic; I2_exp_dose_quadratic; I2_total_dose_quadratic

# Variance explained by dose (quadratic model)
tau2_res_dose_quadratic <- sum(res_dose_quadratic$sigma2)
R2_dose_quadratic <- (tau2_res_3L_nutrient_species - tau2_res_dose_quadratic) / tau2_res_3L_nutrient_species * 100
print(R2_dose_quadratic)

# Intervention preparation
# Set meal as reference
nutrient_data$intervention_preparation <- relevel(nutrient_data$intervention_preparation, ref = "meal")

nutrient_prep_counts <- nutrient_data %>%
  group_by(intervention_preparation) %>%
  summarise(
    n_studies = n_distinct(study_ID),
    n_effects = n_distinct(experiment_ID),
    .groups = "drop"
  )
nutrient_prep_counts

# Run meta-regression
res_prep <- rma.mv(yi = g_nutrient, V = vi_g_nutrient, mods = ~ intervention_preparation, random = list(~ 1 | species, ~ 1 | study_ID / experiment_ID), data = nutrient_data)
summary(res_prep)

# Extract variance components
sigma_species_prep <- res_prep$sigma2[1]
sigma_study_prep <- res_prep$sigma2[2]
sigma_exp_prep <- res_prep$sigma2[3]

# Total variance
total_var_prep <- sigma_species_prep + sigma_study_prep + sigma_exp_prep + mean_vi_nutrient 

# I² calculations
I2_species_prep <- sigma_species_prep / total_var_prep * 100
I2_study_prep   <- sigma_study_prep   / total_var_prep * 100
I2_exp_prep     <- sigma_exp_prep     / total_var_prep * 100
I2_total_prep   <- (sigma_species_prep + sigma_study_prep + sigma_exp_prep) / total_var_prep * 100

I2_species_prep; I2_study_prep; I2_exp_prep; I2_total_prep

# Variance explained by preparation
tau2_res_prep <- sum(res_prep$sigma2)
R2_prep <- (tau2_res_3L_nutrient_species - tau2_res_prep) / tau2_res_3L_nutrient_species * 100
print(R2_prep)

# Assessing collinearity by fitting multivariate MLMR with initial_size, intervention_dose, experimental duration and preparation as moderators
res_nutrient_combined <- rma.mv(
  yi = g_nutrient,
  V  = vi_g_nutrient,
  mods = ~ intervention_dose + I(intervention_dose^2)+ initial_size_g + study_duration_days + intervention_preparation,
  random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID), 
  data = nutrient_data,
  method = "REML"
)
summary(res_nutrient_combined)

# Calculations to determine heterogeneity explained by combined model
vc_res_3L_nutrient_species <- as.numeric(res_3L_nutrient_species$sigma2)
vc_res_nutrient_combined  <- as.numeric(res_nutrient_combined$sigma2)

remaining <- vc_res_nutrient_combined
reduction <- vc_res_3L_nutrient_species - vc_res_nutrient_combined
prop_explained <- (vc_res_3L_nutrient_species - vc_res_nutrient_combined) / vc_res_3L_nutrient_species

heterogeneity_table <- data.frame(
  Level = c("Between species (sigma^2_1)", "Between studies (sigma^2_2)", "Within studies / experiments (sigma^2_3)"),
  Null_Model = vc_res_3L_nutrient_species,
  Moderator_Model = vc_res_nutrient_combined,
  Remaining = remaining,
  Reduction = reduction,
  Proportion_Explained = prop_explained
)

#Publication Bias
#Compute SE, precision, and effective sample size
nutrient_data <- nutrient_data %>%
  mutate(
    se_g = sqrt(vi_g_nutrient),               # standard error of effect size
    precision = 1 / se_g,                      # precision
    n_eff = (treatment_n * control_n) / (treatment_n + control_n),  # effective sample size
    inv_n_eff = 1 / n_eff                       # inverse effective sample size
  )

# Fit three-level MLMA with precision as moderator
res_bias_precision_nutrient <- rma.mv(
  yi = g_nutrient,
  V  = vi_g_nutrient,
  mods = ~ precision,
  random = ~ 1 | study_ID / experiment_ID,
  data = nutrient_data,
  method = "REML"
)

summary(res_bias_precision_nutrient)

#Robust small-sample corrected test for the moderator (CR2, Satterthwaite df)
cr2_test_precision <- coef_test(
  res_bias_precision_nutrient,
  vcov = "CR2",
  cluster = nutrient_data$study_ID,
  test = "Satterthwaite"
)
print(cr2_test_precision)

#Funnel plot
ggplot(nutrient_data, aes(x = g_nutrient, y = precision)) +
  geom_point(shape = 21, fill = "grey", color = "black", size = 3) +  # points
  geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 1) +  # vertical line at 0
  scale_y_continuous(name = "Precision (1/SE)") +
  scale_x_continuous(name = "Effect Size (Hedges' g)") +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.8),
    axis.ticks.length = unit(0.3, "cm"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(face = "bold", hjust = 0.01)
  ) +
  ggtitle("Nutrient Utilisation")

#Calculating optimum dose
# Extract coefficients
coefs <- coef(res_dose_quadratic)
beta0 <- coefs["intrcpt"]
beta1 <- coefs["intervention_dose"]
beta2 <- coefs["I(intervention_dose^2)"]

# Calculate optimum dose (minimum of quadratic)
opt_dose <- -beta1 / (2 * beta2)
opt_dose

# Delta method to estimate SE of optimum dose
vc <- vcov(res_dose_quadratic)[c("intervention_dose","I(intervention_dose^2)"),
                               c("intervention_dose","I(intervention_dose^2)")]
d_beta1 <- -1 / (2 * beta2)
d_beta2 <- beta1 / (2 * beta2^2)

var_opt <- d_beta1^2 * vc["intervention_dose","intervention_dose"] +
           d_beta2^2 * vc["I(intervention_dose^2)","I(intervention_dose^2)"] +
           2 * d_beta1 * d_beta2 * vc["intervention_dose","I(intervention_dose^2)"]

se_opt <- sqrt(var_opt)

# 95% CI for optimum dose
ci_opt <- c(
  optimum_dose = opt_dose,
  CI_lower = opt_dose - 1.96 * se_opt,
  CI_upper = opt_dose + 1.96 * se_opt
)
ci_opt

# Optional: simulation to propagate uncertainty (robust)
n_sims <- 10000
sim_coefs <- mvrnorm(n_sims, mu = coefs[c("intervention_dose","I(intervention_dose^2)")], 
                     Sigma = vc)
opt_sims <- -sim_coefs[,1] / (2 * sim_coefs[,2])

# Predict effect size at optimum dose
beta0_sim <- rnorm(n_sims, mean = beta0, 
                   sd = sqrt(vcov(res_dose_quadratic)["intrcpt","intrcpt"]))
pred_sims <- beta0_sim + sim_coefs[,1]*opt_sims + sim_coefs[,2]*opt_sims^2

pred_opt_CI <- quantile(pred_sims, probs = c(0.025, 0.975))
pred_opt_CI

# Prepare prediction data for dose–response curve
dose_seq <- seq(min(nutrient_data$intervention_dose),
                max(nutrient_data$intervention_dose),
                length.out = 100)

pred <- predict(res_dose_quadratic, 
                newmods = cbind(dose_seq, dose_seq^2))

df_plot <- data.frame(
  dose = dose_seq,
  pred = pred$pred,
  ci.lb = pred$ci.lb,
  ci.ub = pred$ci.ub
)

# Plot dose–response curve with optimum dose
optimum_plot_nutrient <- ggplot(df_plot, aes(x = dose, y = pred)) +
  geom_ribbon(aes(ymin = ci.lb, ymax = ci.ub), alpha = 0.2, fill = "darkgrey") +
  geom_line(color = "black", linewidth = 1) +
  geom_point(data = nutrient_data, aes(x = intervention_dose, y = g_nutrient),
             color = "black", fill = "grey", shape = 21, size = 3) +
  geom_vline(xintercept = opt_dose, linetype = "dashed", color = "black") +
  annotate("text", x = opt_dose, y = max(df_plot$pred) + 0.5,
           label = paste0("Optimum dose ≈ ", round(opt_dose, 1), "%"),
           color = "black", hjust = 0.5, vjust = 0, size = 5) +
  labs(
    x = "Ulva Dose (%)",
    y = "Effect Size (Hedges' g)",
    title = "Dose–response relationship of Ulva inclusion on nutrient effect"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.8),
    axis.ticks.length = unit(0.3, "cm"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(face = "bold", hjust = 0.05),
    axis.title.x = element_text(margin = margin(t = 15)), 
    axis.title.y = element_text(margin = margin(r = 15))  
  )

optimum_plot_nutrient
