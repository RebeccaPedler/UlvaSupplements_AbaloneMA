install.packages(c("tidyr", "tidyverse", "rnaturalearth", "rnaturalearthdata", "sf", "ggplot2", "grid", "dplyr", "patchwork", "here", 
"meta", "metafor", "clubSandwich", "robumeta", "devtools", "MASS"))

# Load necessary libraries
library(dplyr)
library(tidyr)
library(tidyverse)
library(rnaturalearth)   # for map data
library(rnaturalearthdata)
library(sf)              # for spatial handling
library(ggplot2)
library(grid)
library(patchwork)
library(here)
library(metafor)
library(meta)
library(clubSandwich)
library(robumeta)
library(MASS)

#install.packages("pacman")
rm(list = ls())
devtools::install_github("daniel1noble/orchaRd", ref = "main", force = TRUE)
pacman::p_load(devtools, tidyverse, metafor, patchwork, R.rsp, orchaRd, emmeans, ape, phytools, flextable)

###Please download GitHub repository and then run the following
setwd("C:/Users/RebeccaPedler/OneDrive - Yumbah/Documents/R&D/Industry PhD/Trials/Meta analysis/R_datasets")
mydata <- read.csv("Ulva inclusion in Haliotis sp. diets_ A Meta-analysis - Data.csv")

#Add another column to assign short citation
citations <- data.frame(
  study_ID = c("S001", "S002", "S003", "S004", "S005", "S006", "S007", "S008","S009", "S010", "S011"),
  short_citation = c(
    "Bansemer et al. (2016)",
    "Lange et al. (2014)",
    "Stone et al. (2022)",
    "Francis et al. (2021)",
    "Mwangudza (2024)",
    "Falade (2023)",
    "Bates et al. (2017)",
    "Chi et al. (2018)",
    "Angell et al. (2012)",
    "Searle et al. (2025)", 
    "Duong et al. (2021)" 
  ))

mydata <- mydata %>%
  left_join(citations, by = "study_ID")

#Add long outcome names
mydata <- mydata %>%
  mutate(
    outcome_long = case_when(
      outcome == "FI"  ~ "Feed intake",
      outcome == "BG"  ~ "Biomass gain",
      outcome == "CF"  ~ "Condition factor",
      outcome == "FW"  ~ "Final weight",
      outcome == "FSL" ~ "Final shell length",
      outcome == "SG"  ~ "Shell gain",
      outcome == "SGR" ~ "Specific growth rate",
      outcome == "WG"  ~ "Weight gain",
      outcome == "EER" ~ "Energy efficiency ratio",
      outcome == "ED"  ~ "Energy deposition",
      outcome == "FCR" ~ "Feed conversion ratio",
      outcome == "PER" ~ "Protein efficiency ratio",
      outcome == "PD"  ~ "Protein deposition",
      outcome == "LG"  ~ "Length gain",
      outcome == "I" ~ "Ingested feed energy", 
      outcome == "Pg" ~ "Somatic feed energy", 
      outcome == "S" ~ "Shell growth energy",
      TRUE ~ outcome
    )
  )

#########Growth Performance
##Growth Performance
# Filter for growth performance
growth_data <- mydata %>%
  filter(outcome_category == "growth performance")
growth_data$intervention_preparation <- as.factor(growth_data$intervention_preparation)
print(growth_data)

# Calculate effect size (Hedges g) and pooled SD
growth_data <- growth_data %>%
  mutate(
    s_pooled_growth = sqrt(((treatment_n - 1) * treatment_SD^2 + (control_n - 1) * control_SD^2) /
                      (treatment_n + control_n - 2)),
    J_growth = 1 - (3 / (4 * (treatment_n + control_n) - 9)),
    g_growth = J_growth * ((treatment_mean - control_mean) / s_pooled_growth),
    vi_g_growth = (treatment_n + control_n) / (treatment_n * control_n) +
                  (g_growth^2 / (2 * (treatment_n + control_n - 2)))
  )

res_3L_growth <- rma.mv(
  yi = g_growth, V = vi_g_growth,
  random = ~ 1 | study_ID / experiment_ID,
  data = growth_data,
  method = "REML"
)

summary(res_3L_growth)

# Extract variance components
sigma_study <- res_3L_growth$sigma2[1]      # between-study
sigma_exp   <- res_3L_growth$sigma2[2]      # within-study / experimental

# Mean sampling variance
mean_vi_growth <- mean(growth_data$vi_g_growth)

# Calculate IÂ²
I2_study <- sigma_study / (sigma_study + sigma_exp + mean_vi_growth) * 100
I2_exp   <- sigma_exp / (sigma_study + sigma_exp + mean_vi_growth) * 100
I2_total <- (sigma_study + sigma_exp) / (sigma_study + sigma_exp + mean_vi_growth) * 100

I2_study; I2_exp; I2_total

# Orchard plot (overall effect)
orchaRd::orchard_plot(
  res_3L_growth,
  mod = "1",
  at = NULL,
  group = "study_ID",
  xlab = "g_growth",
  transfm = "none",
  twig.size = 0.5,
  trunk.size = 0.1
)

I2 <- orchaRd::i2_ml(res_3L_growth)

orchaRd::orchard_plot(
  res_3L_growth,
  mod = "1",
  xlab = "Effect Size (Hedges g)",
  group = "study_ID"
) +
  annotate(
    geom = "text",
    x = 0.7,
    y = 10,
    label = paste0("italic(I)^{2} == ", round(I2[1], 4), "*\"%\""),
    color = "black",
    parse = TRUE,
    size = 5
  ) +
  scale_fill_manual(values = "grey") +
  scale_colour_manual(values = "grey")

# Testing impact of moderators (univariate)
res_size <- rma.mv(
  yi = g_growth, V = vi_g_growth,
  mods = ~ initial_size_g,
  random = ~ 1 | study_ID / experiment_ID,
  data = growth_data
)
summary(res_size)

res_species <- rma.mv(
  yi = g_growth, V = vi_g_growth,
  mods = ~ species,
  random = ~ 1 | study_ID / experiment_ID,
  data = growth_data
)
summary(res_species)

res_duration <- rma.mv(
  yi = g_growth, V = vi_g_growth,
  mods = ~ study_duration_days,
  random = ~ 1 | study_ID / experiment_ID,
  data = growth_data
)
summary(res_duration)

# Univariate MLMR: dose (linear + quadratic)
res_3L_growth_quad <- rma.mv(
  yi = g_growth, V = vi_g_growth,
  mods = ~ intervention_dose + I(intervention_dose^2),
  random = ~ 1 | study_ID / experiment_ID,
  data = growth_data
)
summary(res_3L_growth_quad)

# Univariate MLMR: preparation
res_prep <- rma.mv(
  yi = g_growth, V = vi_g_growth,
  mods = ~ intervention_preparation,
  random = ~ 1 | study_ID / experiment_ID,
  data = growth_data
)
summary(res_prep)

# Final combined model
res_growth_combined <- rma.mv(
  yi = g_growth,
  V  = vi_g_growth,
  mods = ~ intervention_dose + I(intervention_dose^2) + initial_size_g + species,
  random = ~ 1 | study_ID / experiment_ID,
  data = growth_data,
  method = "REML"
)
summary(res_growth_combined)

# Heterogeneity explained by the combined model
vc_res_3L_growth <- as.numeric(res_3L_growth$sigma2)
vc_res_growth_combined <- as.numeric(res_growth_combined$sigma2)

remaining <- vc_res_growth_combined
reduction <- vc_res_3L_growth - vc_res_growth_combined
prop_explained <- (vc_res_3L_growth - vc_res_growth_combined) / vc_res_3L_growth

heterogeneity_table <- data.frame(
  Level = c("Between studies (sigma^2_1)",
            "Within studies / experiments (sigma^2_2)"),
  Null_Model = vc_res_3L_growth,
  Moderator_Model = vc_res_growth_combined,
  Remaining = remaining,
  Reduction = reduction,
  Proportion_Explained = prop_explained
)

heterogeneity_table

##Publication bias
# Compute SE, precision (1/SE), and an "effective sample size"
growth_data <- growth_data %>%
  mutate(
    se_g = sqrt(vi_g_growth),                    # standard error of effect size
    precision = 1 / se_g,                     
    n_eff = (treatment_n * control_n) / (treatment_n + control_n),
    inv_n_eff = 1 / n_eff                       # inverse effective sample size (not sqrt)
  )

# Fit three-level MLMA with precision as moderator
res_bias_precision_growth <- rma.mv(
  yi   = g_growth,
  V    = vi_g_growth,
  mods = ~ precision,                          
  random = ~ 1 | study_ID / experiment_ID,    
  data = growth_data,
  method = "REML"
)
summary(res_bias_precision_growth)

# Robust small-sample corrected test for the moderator (CR2, Satterthwaite df)
# This gives a more reliable p-value when clustering (few studies)
cr2_test_precision_growth <- coef_test(
  res_bias_precision_growth,
  vcov = "CR2",
  cluster = growth_data$study_ID,
  test = "Satterthwaite"
)
print(cr2_test_precision_growth)

# Create funnel plot data
funnel_data_growth <- growth_data %>%
  mutate(
    se_g = sqrt(vi_g_growth),
    precision = 1 / se_g
  )

# Funnel plot
ggplot(growth_data, aes(x = g_growth, y = precision)) +
  geom_point(shape = 21, fill = "grey", color = "black", size = 3) +
  geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 1) +
  scale_y_continuous(name = "Precision (1/SE)") +
  scale_x_continuous(name = "Effect Size (Hedges g)") +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.8),
    axis.ticks.length = unit(0.3, "cm"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(face = "bold", hjust = 0.01)
  ) +
  ggtitle("B) Growth")
