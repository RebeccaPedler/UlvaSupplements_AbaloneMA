install.packages(c("tidyr", "tidyverse", "rnaturalearth", "rnaturalearthdata", "sf", "ggplot2", "grid", "dplyr", "patchwork", "here", 
"meta", "metafor", "clubSandwich", "robumeta", "devtools", "MASS"))

# Load necessary libraries
library(dplyr)
library(tidyr)
library(tidyverse)
library(rnaturalearth)   # for map data
library(rnaturalearthdata)
library(sf)              # for spatial handling
library(ggplot2)
library(grid)
library(patchwork)
library(here)
library(metafor)
library(meta)
library(clubSandwich)
library(robumeta)
library(MASS)

#install.packages("pacman")
rm(list = ls())
devtools::install_github("daniel1noble/orchaRd", ref = "main", force = TRUE)
pacman::p_load(devtools, tidyverse, metafor, patchwork, R.rsp, orchaRd, emmeans, ape, phytools, flextable)

###Please download GitHub repository and then run the following
setwd("C:/Users/RebeccaPedler/OneDrive - Yumbah/Documents/R&D/Industry PhD/Trials/Meta analysis/R_datasets")
mydata <- read.csv("Ulva inclusion in Haliotis sp. diets_ A Meta-analysis - Data.csv")

#Add another column to assign short citation
citations <- data.frame(
  study_ID = c("S001", "S002", "S003", "S004", "S005", "S006", "S007", "S008","S009", "S010", "S011"),
  short_citation = c(
    "Bansemer et al. (2016)",
    "Lange et al. (2014)",
    "Stone et al. (2022)",
    "Francis et al. (2021)",
    "Mwangudza (2024)",
    "Falade (2023)",
    "Bates et al. (2017)",
    "Chi et al. (2018)",
    "Angell et al. (2012)",
    "Searle et al. (2025)", 
    "Duong et al. (2021)" 
  ))

mydata <- mydata %>%
  left_join(citations, by = "study_ID")

#Add long outcome names
mydata <- mydata %>%
  mutate(
    outcome_long = case_when(
      outcome == "FI"  ~ "Feed intake",
      outcome == "BG"  ~ "Biomass gain",
      outcome == "CF"  ~ "Condition factor",
      outcome == "FW"  ~ "Final weight",
      outcome == "FSL" ~ "Final shell length",
      outcome == "SG"  ~ "Shell gain",
      outcome == "SGR" ~ "Specific growth rate",
      outcome == "WG"  ~ "Weight gain",
      outcome == "EER" ~ "Energy efficiency ratio",
      outcome == "ED"  ~ "Energy deposition",
      outcome == "FCR" ~ "Feed conversion ratio",
      outcome == "PER" ~ "Protein efficiency ratio",
      outcome == "PD"  ~ "Protein deposition",
      outcome == "LG"  ~ "Length gain",
      outcome == "I" ~ "Ingested feed energy", 
      outcome == "Pg" ~ "Somatic feed energy", 
      outcome == "S" ~ "Shell growth energy",
      TRUE ~ outcome
    )
  )

#########Growth Performance
##Growth Performance
# Filter for growth performance
growth_data <- mydata %>%
  filter(outcome_category == "growth performance")
growth_data$intervention_preparation <- as.factor(growth_data$intervention_preparation)
print(growth_data)

#Summarise k and unique study_ID
growth_data %>%
  summarise(n_studies = n_distinct(study_ID), n_effects = n_distinct(experiment_ID))

# Calculate effect size (Hedges g) and pooled SD
growth_data <- growth_data %>%
  mutate(
    s_pooled_growth = sqrt(((treatment_n - 1) * treatment_SD^2 + (control_n - 1) * control_SD^2) /
                      (treatment_n + control_n - 2)),
    J_growth = 1 - (3 / (4 * (treatment_n + control_n) - 9)),
    g_growth = J_growth * ((treatment_mean - control_mean) / s_pooled_growth),
    vi_g_growth = (treatment_n + control_n) / (treatment_n * control_n) +
                  (g_growth^2 / (2 * (treatment_n + control_n - 2)))
  )

res_3L_growth_wspecies <- rma.mv(
  yi = g_growth, V = vi_g_growth,
  random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID 
  ),
  data = growth_data,
  method = "REML"
)
summary(res_3L_growth_wspecies)

# Extract variance components
sigma_species_growth <- res_3L_growth_wspecies$sigma2[1]
sigma_study_growth <- res_3L_growth_wspecies$sigma2[2]
sigma_exp_growth <- res_3L_growth_wspecies$sigma2[3]

# Mean sampling variance
mean_vi_growth <- mean(growth_data$vi_g_growth)

# Total variance
total_var_growth <- sigma_species_growth + sigma_study_growth + sigma_exp_growth + mean_vi_growth

# IÂ² calculations
I2_species_growth <- sigma_species_growth / total_var_growth * 100
I2_study_growth <- sigma_study_growth / total_var_growth * 100
I2_exp_growth <- sigma_exp_growth / total_var_growth * 100
I2_total_growth <- (sigma_species_growth + sigma_study_growth + sigma_exp_growth) / total_var_growth * 100

I2_species_growth; I2_study_growth; I2_exp_growth; I2_total_growth

#Testing impact of moderators in univariate models
res_size <- rma.mv(yi = g_growth, V = vi_g_growth, mods = ~ initial_size_g, random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID), 
data = growth_data)
summary(res_size)

#growth performance outcome
res_outcome <- rma.mv(yi = g_growth, V = vi_g_growth, mods = ~ outcome, random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID), 
data = growth_data)
summary(res_outcome)

#study duration
res_study_duration <- rma.mv(yi = g_growth, V = vi_g_growth, mods = ~ study_duration_days, random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID), 
data = growth_data)
summary(res_study_duration)

#Ulva preparation
res_intervention_preparation <- rma.mv(yi = g_growth, V = vi_g_growth, mods = ~ intervention_preparation, random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID), 
data = growth_data)
summary(res_intervention_preparation)

#intervention dose
res_intervention_dose <- rma.mv(yi = g_growth, V = vi_g_growth, mods = ~ intervention_dose, random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID), 
data = growth_data)
summary(res_intervention_dose)

#intervention dose (quadratic)
res_intervention_dose_quad <- rma.mv(yi = g_growth, V = vi_g_growth, mods = ~ intervention_dose + I(intervention_dose^2), random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID), 
data = growth_data)
summary(res_intervention_dose_quad)

#Final multivariate model 1
res_growth_multi_1 <- rma.mv(yi = g_growth, V = vi_g_growth, mods = ~ intervention_dose + initial_size_g + study_duration_days, random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID), 
data = growth_data)
summary(res_growth_multi_1)

#Final multivariate model final
res_growth_multi <- rma.mv(yi = g_growth, V = vi_g_growth, mods = ~ initial_size_g + intervention_dose, random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID), 
data = growth_data)
summary(res_growth_multi)

# Extract variance components
vc_null  <- as.numeric(res_3L_growth_wspecies$sigma2)
vc_mod   <- as.numeric(res_growth_multi$sigma2)

# Sanity check
stopifnot(length(vc_null) == 3, length(vc_mod) == 3)

# Calculate reduction and proportion explained
reduction <- vc_null - vc_mod
prop_explained <- reduction / vc_null

# Build table
heterogeneity_table <- data.frame(
  Level = c("Between species (sigma^2_1)",
            "Between studies (sigma^2_2)",
            "Within studies / experiments (sigma^2_3)"),
  Null_Model = vc_null,
  Moderator_Model = vc_mod,
  Reduction = reduction,
  Proportion_Explained = prop_explained
)

heterogeneity_table

#Publication bias
# Compute SE, precision, and effective sample size for all_data
growth_data <- growth_data %>%
  mutate(
    se_g = sqrt(vi_g_growth),                    # standard error of effect size
    precision = 1 / se_g,                     
    n_eff = (treatment_n * control_n) / (treatment_n + control_n),
    inv_n_eff = 1 / n_eff                       # inverse effective sample size (not sqrt)
  )

# Fit three-level MLMA with precision as moderator
res_bias_precision_growth <- rma.mv(
  yi   = g_growth,
  V    = vi_g_growth,
  mods = ~ precision,                       
  random = list(
    ~ 1 | species,                  
    ~ 1 | study_ID / experiment_ID 
  ), 
  data = growth_data,
  method = "REML")
summary(res_bias_precision_growth)

# Robust small-sample corrected test for the moderator (CR2, Satterthwaite df)
cr2_test_precision <- coef_test(
  res_bias_precision_growth,
  vcov = "CR2",
  cluster = growth_data$species,    #experiment and study nested within species
  test = "Satterthwaite"
)
print(cr2_test_precision)

# Create funnel plot
ggplot(growth_data, aes(x = g_growth, y = precision)) +
  geom_point(shape = 21, fill = "grey", color = "black", size = 3) +  
  geom_vline(xintercept = 0, linetype = "dotted", color = "black", size = 1) +  
  scale_y_continuous(name = "Precision (1/SE)") +
  scale_x_continuous(name = "Effect Size (Hedges g)") +
  theme_minimal(base_size = 14) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black", linewidth = 0.8),
    axis.ticks.length = unit(0.3, "cm"),
    axis.ticks = element_line(color = "black"),
    plot.title = element_text(face = "bold", hjust = 0.01)
  ) +
  ggtitle("Growth Performance")
