# Project: Feeding behaviour, growth performance and nutrient utilisation of abalone with dietary Ulva sp. supplementation: A meta-analysis 

## Step3: Data checking and summarising. 

## Working with the raw data for meta-analysis - main data set.

## Install packages
# install.packages(c("tidyr", "tidyverse", "rnaturalearth", "rnaturalearthdata", "sf", "ggplot2", "grid", "dplyr", "patchwork", "here"))


## Load required libraries
library(dplyr)
library(tidyr)
library(tidyverse)
library(rnaturalearth)   # for map data
library(rnaturalearthdata)
library(sf)              # for spatial handling
library(ggplot2)
library(grid)
library(patchwork)
library(here)
library(devtools)

# install.packages("devtools")
devtools::install_github("davidsjoberg/ggsankey")

## Load data
mydata <- read_csv(here("Data", "ulva_meta_analysis_raw_data.csv"))
dim(mydata)
names(mydata)

## Add another column to assign short citation for each study
citations <- data.frame(
  study_ID = c("S001", "S002", "S003", "S004", "S005", "S006", "S007", "S008","S009", "S010", "S011"),
  short_citation = c(
    "Bansemer et al. (2016)",
    "Lange et al. (2014)",
    "Stone et al. (2022)",
    "Francis et al. (2021)",
    "Mwangudza (2024)",
    "Falade (2023)",
    "Bates et al. (2017)",
    "Chi et al. (2018)",
    "Angell et al. (2012)",
    "Searle et al. (2025)", 
    "Duong et al. (2021)" 
  ))

mydata <- dplyr::left_join(mydata, citations, by = "study_ID")
dim(mydata)

## Add long outcome names
mydata <- mydata %>%
  mutate(
    outcome_long = case_when(
      outcome == "FI"  ~ "Feed intake",
      outcome == "BG"  ~ "Biomass gain",
      outcome == "CF"  ~ "Condition factor",
      outcome == "FW"  ~ "Final weight",
      outcome == "FSL" ~ "Final shell length",
      outcome == "SG"  ~ "Shell gain",
      outcome == "SGR" ~ "Specific growth rate",
      outcome == "WG"  ~ "Weight gain",
      outcome == "EER" ~ "Energy efficiency ratio",
      outcome == "ED"  ~ "Energy deposition",
      outcome == "FCR" ~ "Feed conversion ratio",
      outcome == "PER" ~ "Protein efficiency ratio",
      outcome == "PD"  ~ "Protein deposition",
      outcome == "LG"  ~ "Length gain",
      outcome == "I" ~ "Ingested feed energy", 
      outcome == "Pg" ~ "Somatic feed energy", 
      outcome == "S" ~ "Shell growth energy",
      TRUE ~ outcome
    )
  )


##### Study Characteristics

# Get unique study IDs
#mydata$study_ID
length(unique(mydata$study_ID)) #11

## Rename experiment_ID to ES_ID
mydata <- mydata %>%
  rename(ES_ID = experiment_ID)

## Number of ES_ID (observations) per study
mydata %>%
  group_by(study_ID) %>%
  summarise(
    n_experiments = n_distinct(ES_ID),
    .groups = "drop"
  ) %>%
  summarise(
    min    = min(n_experiments),
    max    = max(n_experiments),
    mean   = mean(n_experiments),
    median = median(n_experiments)
  )

## Count number of ES_ID (observations) per outcome
mydata %>%
  group_by(outcome_long) %>%
  summarise(
    count = n(),      
    .groups = "drop"
  )

## Count number of ES_ID (observations) per outcome category
mydata %>%
  group_by(outcome_category) %>%
  summarise(
    count = n(),        
    .groups = "drop"
  )

## Count number of ES_ID (observations) per species
mydata %>%
  group_by(species) %>%
  summarise(
    count = n(),        # number of times each combo appears
    .groups = "drop"
  )

# Fix species names in mydata - replace word "Haliotis" with "H.":
mydata <- mydata %>%
  mutate(
    species = gsub("Haliotis", "H.", species)
  ) %>%
  mutate(
    species = gsub(" x ", "_x_", species)
  )

## Check consistency of categorisation of outcomes:
table(mydata$outcome_long, mydata$outcome_category) #Final weight categorised both as growth performance and feed behaviour - need to fix this.

## Fix outcome category for "Final weight" to be "growth performance"
mydata <- mydata %>%
  mutate(outcome_category = ifelse(outcome_long == "Final weight", "growth performance", outcome_category)
  )


## Count number of records per species–outcome combination
bubble_data <- mydata %>%
  group_by(species, outcome_long, outcome_category) %>%
  summarise(
    count = n(),        # number of times each combo appears
    .groups = "drop"
  )


## Build a bubble plot with y-axis ordered by total counts per outcome and x by species:
bubble_plot_species <- ggplot(bubble_data, aes(x = fct_infreq(species), y = fct_rev(fct_infreq(outcome_long)) )) +
  geom_point(
    aes(size = count, fill = outcome_category),
    shape = 21,
    color = "black",
    alpha = 0.9
  ) +
  scale_size_continuous(
    range = c(3, 15),
    breaks = c(2, 5, 10),
    name = "Number of Observations"
  ) +
  scale_fill_manual(
    values = c(
      "growth performance" = "steelblue",
      "nutrient utilisation" = "grey70",
      "feed behaviour" = "white"
    )
  ) +
  labs(
    #title = "A",
    x = "Species",
    y = "Outcome",
    size = "Number of Observations",
    fill = "Outcome Category"
  ) +
  guides(
    size = guide_legend(override.aes = list(size = 8)),
    fill = guide_legend(override.aes = list(size = 8))
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text.x = element_text(hjust = 1, face = "italic", angle = 45),
    axis.text.y = element_text(size = 10),
    plot.title = element_text(face = "bold", hjust = 0.05),
    panel.grid.major = element_line(color = "grey85"),
    panel.grid.minor = element_blank(),
    axis.ticks.length = unit(0.25, "cm"),
    axis.ticks = element_line(color = "black"),
    axis.line = element_line(color = "black"),
    panel.border = element_blank(),
    legend.position = "right"
  ) +
  coord_cartesian(clip = "off")

## Show the plot:
bubble_plot_species


## Recode country names to match rnaturalearth conventions
mydata <- mydata %>%
  mutate(country_standardised = case_when(
    country == "Australia"     ~ "Australia",
    country == "China"         ~ "China",
    country == "Hawaii"        ~ "United States of America",  # Hawaii is part of USA
    country == "Indonesia"     ~ "Indonesia",
    country == "Ireland"       ~ "Ireland",
    country == "Japan"         ~ "Japan",
    country == "Korea"         ~ "South Korea",               # or "Republic of Korea"
    country == "New Zealand"   ~ "New Zealand",
    country == "South Africa"  ~ "South Africa",
    country == "Taiwan"        ~ "Taiwan",                    # not always present in shapefile
    TRUE                       ~ country                      # default: keep original
  ))

## Summarise data by country
country_summary <- mydata %>%
  group_by(country_standardised) %>%
  summarise(
    observation_count = n(),                                  # count all rows
    percentage = 100 * observation_count / nrow(mydata),      # proportion of total rows
    .groups = "drop"
  ) %>%
  rename(name = country_standardised)
print(country_summary)


## Get world map shapefile for plotting and remove Antarctica:
world <- ne_countries(scale = "medium", returnclass = "sf")
world <- world %>% filter(name != "Antarctica") #remove the continent from the spatial object for cleaner mapping

## Join country summary with world shapefile:
world_data <- world %>%
  left_join(country_summary, by = "name")

## Plot heat map of frequency by country:
world_map <- ggplot(world_data) +
  geom_sf(aes(fill = observation_count)) +
  scale_fill_gradient(
    low = "#deebf7",
    high = "#08306b",
    na.value = "grey90",
    name = "Number of\nComparisons"   # line break in legend title
  ) +
  labs(
    #title = "B",
    caption = "Grey areas = no studies"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    legend.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold"),
    plot.subtitle = element_text(face = "italic"),
    panel.grid = element_blank()           # remove all gridlines
  )   +
  theme(legend.position = "bottom") #+ # Move legend to bottom

## Display the plot:
world_map


# # Combine side by side with one shared legend = NOT YET (also it should be vertical not horizontal)
# species_and_map_combined <- bubble_plot_species + world_map +
#   plot_annotation(tag_levels = 'A') &          # & applies theme to all plots
#   theme(plot.tag = element_text(face = "bold", size = 14))
# species_and_map_combined


### Summarise number and percentage of unique studies per publication year
#table(mydata$study_ID, mydata$publication_year)
publication_summary <- mydata %>%
  distinct(study_ID, publication_year) %>%
  group_by(publication_year) %>%
  summarise(unique_study_count = n()) %>%
  mutate(
    percentage = 100 * unique_study_count / 11,
    label_percent = paste0(round(percentage, 1), "%"),
    label_count = unique_study_count
  )
print(publication_summary)


### Check study validity metrics (study-level variables)

## Simple frequency tables for each validity metric:
table(mydata$study_ID, mydata$random_assignment) #5/11 yes, 6/11 no
table(mydata$study_ID, mydata$blind_measurement) #all no
table(mydata$study_ID, mydata$protocol_registration) #all no
table(mydata$study_ID, mydata$raw_data_availability) #all no
table(mydata$study_ID, mydata$raw_data_availability)  #all no
table(mydata$study_ID, mydata$funding_disclosed)  #all yes
table(mydata$study_ID, mydata$funding_potential_COI)  #8/11 yes, 3/11 no
table(mydata$study_ID, mydata$COI_disclosed)  #3/11 have COI statement, with 1 COI disclosed
table(mydata$study_ID, mydata$publication_type) #3/11 Grey literature, 8/11 Primary literature


## Simple frequency tables for each study design characteristics for numbers of effect sizes and numbers of studies per moderator value:

table(mydata$study_ID, mydata$study_duration_days)  #4-2733 days, 2 studies have 2 durations
#colSums(table(mydata$study_ID, mydata$study_duration_days) != 0) # counts of studies per moderator value

table(mydata$study_ID, mydata$initial_size_g)  #0.54 - 94.73g, 2 studies have 2-3 initial sizes
#colSums(table(mydata$study_ID, mydata$initial_size_g) != 0) # counts of studies per moderator value

table(mydata$study_ID, mydata$water_temperature) #12-26.5C, 7 studies have 2-3 temperatures, one study has 3 ranges of temperatures (S003)
#colSums(table(mydata$study_ID, mydata$water_temperature) != 0) # counts of studies per moderator value

table(mydata$study_ID, mydata$experimental_system) # 7 Laboratory; 4 Land-based farm
#colSums(table(mydata$study_ID, mydata$experimental_system) != 0) # counts of studies per moderator value

table(mydata$study_ID, mydata$experimental_unit) # 2 Basket, cage and/or net; 2 Raceway; 7 Tank-based
#colSums(table(mydata$study_ID, mydata$experimental_unit) != 0) # counts of studies per moderator value

table(mydata$study_ID, mydata$intervention_species) # 6 studies report "Ulva sp.", 5 give species name - each a different one - not good for analyses
#colSums(table(mydata$study_ID, mydata$intervention_species) != 0)  # counts of studies per moderator value

table(mydata$study_ID, mydata$intervention_preparation)  # 9 studies use meal, 1 liquid fermented, 1 protein extract - not good for analyses
#colSums(table(mydata$study_ID, mydata$intervention_preparation) != 0)  # counts of studies per moderator value

table(mydata$study_ID, mydata$intervention_dose)  #0.25-30 dose levels, 5 studies have multiple dose levels
#colSums(table(mydata$study_ID, mydata$intervention_dose) != 0)  #counts of studies per moderator value

table(mydata$study_ID, mydata$feeding_conditions)  # 10 studies treated daily, 1 study treated Once
#colSums(table(mydata$study_ID, mydata$feeding_conditions) != 0)  # counts of studies per moderator value

table(mydata$study_ID, mydata$study_conditions)  # 11 studies have Basal conditions, 2 challenge (both Basal and Challenge)
#colSums(table(mydata$study_ID, mydata$study_conditions) != 0)  # counts of studies per moderator value

table(mydata$study_ID, mydata$challenge_category) # 2 studies have both basal conditions (NA) and Thermal challenge
#colSums(table(mydata$study_ID, mydata$challenge_category) != 0) # counts of studies per moderator value

table(mydata$study_ID, mydata$units) #mix of unites.; au = arbitrary units
#colSums(table(mydata$study_ID, mydata$units) != 0) # counts of studies per moderator value

table(mydata$study_ID, mydata$proportional_data) #all No - needs more checking!
#colSums(table(mydata$study_ID, mydata$proportional_data) != 0) # counts of studies per moderator value

table(mydata$study_ID, mydata$control_n_description) #1 study at indiv. abalone-level (1ES), 10 at Tank-level, 1 at chamber level
#colSums(table(mydata$study_ID, mydata$control_n_description) != 0) # counts of studies per moderator value

table(mydata$study_ID, mydata$control_n)  #3-5 tanks sample sizes; some studies have different sample sizes for different outcomes
#colSums(table(mydata$study_ID, mydata$control_n) != 0)  # counts of studies per moderator value

table(mydata$study_ID, mydata$treatment_n)  #3-5 tanks sample sizes; some studies have different sample sizes for different outcomes
#colSums(table(mydata$study_ID, mydata$treatment_n) != 0)  # counts of studies per moderator value

table(mydata$study_ID, mydata$outcome_long)  # many outcomes just in 1 study
#colSums(table(mydata$study_ID, mydata$outcome_long) != 0)  # counts of studies per moderator value

table(mydata$study_ID, mydata$outcome_category)  # 5-9 studies per outcome category, but some have very few observations; some studies have only 1 outcome category
#colSums(table(mydata$study_ID, mydata$outcome_category) != 0)  # counts of studies per moderator value


## Some two-way tables to look at the overlaps at the observations level (examples - check distribution of other moderators as needed):
table(mydata$study_duration_days, mydata$outcome_category)
table(mydata$water_temperature, mydata$outcome_category)
table(mydata$intervention_dose, mydata$outcome_category)
table(mydata$experimental_system, mydata$outcome_category)
table(mydata$experimental_unit, mydata$outcome_category)

###Create Sankey plot to investigate moderator overlap and/or potential collinearity 
###Create alluvial plot to visualise overlap between moderators and potential collinearity

##Create bins for continious numerical data and order ascending
mydata_alluvial <- mydata %>%
  mutate(
    dose_cat = cut(
      intervention_dose,
      breaks = c(0, 2.5, 5, 10, 20, 30, Inf),
      labels = c("≤2.5%", "2.5–5%", "5–10%", "10-20%", "20-30%", ">30%"),
      right = TRUE
    ),
    
    duration_cat = cut(
      study_duration_days,
      breaks = c(0, 30, 60, 120, 180, Inf),
      labels = c("≤30 d", "30-60 d", "60–120 d", "120–180 d", ">180 d"),
      right = TRUE
    ),
    
    size_cat = cut(
      initial_size_g,
      breaks = c(0, 1, 10, 50, Inf),
      labels = c("≤1 g", "1–10 g", "10–50 g", ">50 g"),
      right = TRUE
    ))

#Makes labels ascending order
    mydata_alluvial <- mydata_alluvial %>%
    mutate(
    dose_cat = factor(dose_cat, levels = c("≤2.5%", "2.5–5%", "5–10%", "10-20%", "20-30%", ">30%")),
    duration_cat = factor(duration_cat, levels = c("≤30 d", "30-60 d", "60–120 d", "120–180 d", ">180 d")),
    size_cat = factor(size_cat, levels = c("≤1 g", "1–10 g", "10–50 g", ">50 g")))

##Prepare species names 
#Check names 
unique(mydata_alluvial$species)

 # Replace 'Haliotis ' with 'H. '
mydata_alluvial <- mydata_alluvial %>%
  mutate(species = str_replace(species, "^Haliotis ", "H. "))

### Create Plot     
# pre-process
mydata_alluvial <- mydata_alluvial %>%
  dplyr::select(species, experimental_system,  study_conditions, intervention_preparation, dose_cat, duration_cat, size_cat) #select columns for the plot

ggplot(dlong(mydata_alluvial, species, experimental_system,  study_conditions, intervention_preparation, dose_cat, duration_cat, size_cat), aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  sankey_p(flow.alpha = 0.8,
              node.color = "transparent") +
  sankey_p_label(size = 3, color = "white", fill = "gray10", alpha = 0.6) +
  ggsci::scale_color_tron() + 
  theme_sankey(base_size = 10) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5),
    axis.text.x = ggtext::element_markdown(color = "black", size = 8) 
   ) +
scale_x_discrete(labels = c("Species", "Experimental \n System", "Study \n conditions",  "Ulva \n preparation", "Ulva dose \n (%)", "Study duration \n (days)", "Initial abalone \n size (g)"), position = "top") 

ggsave("Sankey_plot.png", width = 14, height = 7, units = "in")

## Check and fix proportional_data column based on units:
## In mydata$units raplace "au" with "arbitrary unts":
mydata <- mydata %>%  mutate(units = ifelse(units == "au", "arbitrary units", units)  )

## Two way table to match units to proportional_data:
table(mydata$units, mydata$proportional_data) #FIX: %, %BW/day, g/100g BW/day, g/kg abalone/day - are any a true % = proportions (range 0-1)?

## Show records with units == "%":
mydata %>% filter(units %in% c("%")) %>% View() #"Energy deposition" and "Protein deposition"  are true %, but weight gain is >100% in some cases - so data are proportional (not true %)
## Show records with units == "%BW/day":
mydata %>% filter(units %in% c("%BW/day")) %>% View() #growth or feed intake - not true %
## Show records with units == "g/100g BW/day":
mydata %>% filter(units %in% c("g/100g BW/day")) %>% View() #feed intake - not true %
## Show records with units == "g/kg abalone/day":
mydata %>% filter(units %in% c("g/kg abalone/day")) %>% View() #feed intake - not true %

## Fix proportional_data column to "Yes" if units == "%") AND (outcome_long == "Energy deposition" or "Protein deposition"):
mydata <- mydata %>%
  mutate(proportional_data = ifelse(
    units == c("%") & outcome_long %in% c("Energy deposition", "Protein deposition"),
    "Yes",
    proportional_data
  ))

## Two way table to match units to proportional_data:
table(mydata$units, mydata$proportional_data) #FIX: %, %BW/day, g/100g BW/day, g/kg abalone/day - are any a true % = proportions (range 0-1)?


# ## Summarise study design characteristics
# vars_characteristics <- c("study_duration_days", "initial_size_g", "water_temperature")
# summary_stats_characteristics <- data.frame(
#   variable = vars_characteristics,
#   median = sapply(mydata[vars_characteristics], median, na.rm = TRUE),
#   min = sapply(mydata[vars_characteristics], min, na.rm = TRUE),
#   max = sapply(mydata[vars_characteristics], max, na.rm = TRUE)
# )
# summary_stats_characteristics



### Summarise and check values relevant for effect sizes

## Check for any missing means, SDs, SEs,  or sample sizes:
mydata %>%  filter(is.na(treatment_mean) | is.na(control_mean)) %>% dim() # No missing means found
mydata %>%  filter(is.na(treatment_SD) | is.na(control_SD)) %>% dim()   # No missing SDs found
mydata %>%  filter(is.na(treatment_SE) | is.na(control_SE)) %>% dim()   # 72 missing SEs found
mydata %>%  filter(is.na(treatment_n) | is.na(control_n)) %>% dim()    # No missing sample sizes found

## Fill in misssing SE from SD and n:
mydata <- mydata %>%
  mutate(
    treatment_SE = ifelse(is.na(treatment_SE), treatment_SD / sqrt(treatment_n), treatment_SE),
    control_SE
    = ifelse(is.na(control_SE), control_SD / sqrt(control_n), control_SE)
  )

## Check again for any missing SEs:
mydata %>%  filter(is.na(treatment_SE) | is.na(control_SE)) %>% dim()   # No missing SEs found now



## Check for any zero means or SDs that would cause issues with effect size calculations:
mydata %>%  filter(treatment_mean == 0 | control_mean == 0) %>% dim() # No zero means found
mydata %>%  filter(treatment_SD == 0 | control_SD == 0) %>% dim()   # 4 zero SDs found: S004.11, S004.22, S004.23, S004.35 - problematic for ES calculations


### CV
# Note: Coefficient of Variation (CV = \(\sigma /\mu \)).
# Bbiological data usually display a CV between 0.05 (5%) and 0.5 (50%), so need to check for atypical values

## Calculate treatment CV - treatment_SD to treatment_mean ratio:

mydata <- mydata %>%
  mutate(control_CV = control_SD / control_mean) %>%
  mutate(treatment_CV = treatment_SD / treatment_mean)

## get the ranges of CV:
range(mydata$control_CV)
range(mydata$treatment_CV)

## make hjostograms of CV:
ggplot(mydata, aes(x = control_CV)) +
  geom_histogram(binwidth = 0.01, fill = "steelblue", color = "black") +
  labs(
    title = "Distribution of Treatment Mean to SD Ratio (CV)",
    x = "CV",
    y = "Frequency"
  ) +
  theme_minimal()

ggplot(mydata, aes(x = treatment_CV)) +
  geom_histogram(binwidth = 0.01, fill = "steelblue", color = "black") +
  labs(
    title = "Distribution of Treatment Mean to SD Ratio (CV)",
    x = "CV",
    y = "Frequency"
  ) +
  theme_minimal()


## Show rows with CV == 0:
mydata %>% filter(treatment_CV == 0 | control_CV == 0) %>% View() # 4 rows with zero SDs (all S004, mostly arbitrary=y units) - CHECK MANUALLY! (and substitute)
#mydata %>% filter(study_ID == "S004") %>% View() # see all records from S004

## Replace zero SDs with 0.02 and SEs with 0.01 (smallest non-zero values from the same study and measurement units) to avoid issues in ES calculations:
mydata <- mydata %>%
  mutate(
    treatment_SD = ifelse(treatment_SD == 0, 0.02, treatment_SD),
    treatment_SE = ifelse(treatment_SE == 0, 0.01, treatment_SE),
    control_SD = ifelse(control_SD == 0, 0.02, control_SD),
    control_SE = ifelse(control_SE == 0, 0.01, control_SE)
  )

## Show rows with CV < 0.005 (141 has <0.05):
mydata %>% filter(treatment_CV < 0.005 | control_CV < 0.005) %>% View() # 14 rows with low SDs (including 4 with 0) - CHECK MANUALLY and fix SDs, SEs here using R code, if needed!

## Show rows with CV > 0.5:
mydata %>% filter(treatment_CV > 0.5 | control_CV > 0.5) %>% View() # 9 rows with high SDs - CHECK MANUALLY and fix SDs, SEs here using R code,  if needed!

#ES_ID where CV > 0.5 manually checked in original publication
#S003.3, S006.3, S011.10, S011.11, S012.12, S002.13, S002.14 checked in article - true reported value

#ES_ID where CV < 0.005 manually checked in original publication
# S001.6, S004.11, S004.23, S004.35, S006.23, S006.26 - true reported value
#SE for ES_ID = S001.16, S001.18 and S001.26 entered as 0.007, true SE from article is 0.07
#S004.22 control_SE and treatment_SE entered wrong way around
#S008.2, S008.8, S008.14 CONTROL_SE entered as 0.01, true SE is 0.07
#S004.27 control_mean and control_SE data entered into treatment_mean and treatment_SE

##Let's fix errors
mydata <- mydata %>%
  mutate(
    # Fix incorrect control_SE
    control_SE = case_when(
      ES_ID %in% c("S001.16", "S001.18", "S001.26") ~ 0.07,
      ES_ID %in% c("S008.2", "S008.8", "S008.14") ~ 0.07,
      ES_ID == "S004.22"                          ~ 0.10,
      TRUE ~ control_SE
    ),

    # Fix incorrect treatment_mean
    treatment_mean = case_when(
      ES_ID == "S004.27" ~ 99.0,
      TRUE ~ treatment_mean
    ),

    #Fix incorrect treatment_SE
    treatment_SE = case_when(
      ES_ID == "S004.27" ~ 0.70,
      ES_ID == "S004.22" ~ 0.00,
      TRUE ~ treatment_SE
    )
  )

##Recalculate SD and CV for ammended ES_ID
# Define amended ES_IDs 
amended_ES <- c(
  "S001.16", "S001.18", "S001.26",
  "S008.2", "S008.8", "S008.14",
  "S004.27", "S004.22"
)

mydata <- mydata %>%
  mutate(
# control_SD
    control_SD = if_else(
      ES_ID %in% amended_ES,
      control_SE * sqrt(control_n),
      control_SD
    ),
# treatment_SD
    treatment_SD = if_else(
      ES_ID %in% amended_ES,
      treatment_SE * sqrt(treatment_n),
      treatment_SD
    ),
# control_CV
    control_CV = if_else(
      ES_ID %in% amended_ES,
      control_SD / control_mean,
      control_CV
    ),
# treatment_CV
    treatment_CV = if_else(
      ES_ID %in% amended_ES,
      treatment_SD / treatment_mean,
      treatment_CV
    )
  )

##Now reperform CV < 0.005 checks
## Show rows with CV < 0.005:
mydata %>% filter(treatment_CV < 0.005 | control_CV < 0.005) %>% View() # S001.18, S004.22, S004.27 still < 0.005 despite ammending
  
### Save cleaned data for meta-analysis
write_csv(mydata, here("Data", "cleaned_data_for_meta_analysis.csv"))

## TODO:
#[] summarise study characteristics (some done above) - could be a table or a diagram/infographics

### End of script ###

### NEXT ###: Use cleaned data from the output file *"cleaned_data_for_meta_analysis.csv"* to calculate effect sizes (lnRR and SMD). 
